#!/bin/sh

read -p "enter the cPanel username: " cpuser
cd "/home/$cpuser/public_html"

sqldump=$(find . -name \*.sql -type f)

if [ -z $sqldump ];

then echo "No sql file, nothing to do"

else

#dbnames=($(grep $sqldump -Poe "CREATE DATABASE [^\`]*\`\K[^\`]*"))
#dbusers=($(grep -Pzo "(?s)INTO .?user.? VALUES[^(]\K[^;]*" $sqldump | grep -Pao "\([^,]*,\K[^,]*"))
wpconfig=$(find . -name wp-config.php -type f)
wpdb=$(cat wp-config.php | grep DB_NAME | cut -d \' -f 4)
wpuser=$(cat wp-config.php | grep DB_USER | cut -d \' -f 4)
newwpuser=$cpuser"_"$wpuser
newwpdb=$cpuser"_"$wpdb

#Find the .user entries & add the prefix

grep -Pzo '(?s)INTO .?user.? VALUES[^(]\K[^;]*' $sqldump | grep -Pao '\([^,]*,\K[^,]*'

echo "Prefixes now added - new output"

grep -Pzo '(?s)INTO .?user.? VALUES[^(]\K[^;]*' $sqldump | grep -Pao '\([^,]*,\K[^,]*'


#Find the .db entries & add the prefix

grep -Pzo '(?s)INTO .?db.? VALUES[^(]\K[^;]*' $sqldump | grep -Pao '\(([^,]*,){1}\K[^,]*'
grep -Pzo '(?s)INTO .?db.? VALUES[^(]\K[^;]*' $sqldump | grep -Pao '\(([^,]*,){2}\K[^,]*'

echo "Prefixes now added - new output"

grep -Pzo '(?s)INTO .?db.? VALUES[^(]\K[^;]*' $sqldump | grep -Pao '\(([^,]*,){1}\K[^,]*'
grep -Pzo '(?s)INTO .?db.? VALUES[^(]\K[^;]*' $sqldump | grep -Pao '\(([^,]*,){2}\K[^,]*'

#Now lets do some clever work and add prefixes pre the db dump & subsequent use commands

find . -name '*.sql' -exec sed -i "s/\\(CREATE DATABASE [^\`]*\`\\)/\\1${cpuser}_/" {} +
find . -name '*.sql' -exec sed -i "s/\\(USE [^\`]*\`\\)/\\1${cpuser}_/" {} +

#IMPORT THE DUMP

mysql -u root < $sqldump

#Map the DBs & users to a cpanel user

for i in ${dbnames[@]}; do /usr/local/cpanel/bin/dbmaptool $cpuser --type mysql --dbs $i; done
for i in ${dbusers[@]}; do /usr/local/cpanel/bin/dbmaptool $cpuser --type mysql --dbusers $i; done

#Let's update the wordpress config if there is one

if [ -z $wpconfig ]; 

then echo "No WP Config, skipping section, migration completed"

else

find . -name 'wp-config.php' -exec sed -i -e "/DB_NAME/s/'$wpdb'/'$newwpdb'/" {} +
find . -name 'wp-config.php' -exec sed -i -e "/DB_USER/s/'$wpuser'/'$newwpuser'/" {} +

#Let's Check the wp-config new output (should be prefixed)

echo WP Config located at $wpconfig
echo WP DB is now showing as $wpdb
echo WP User is now showing as $wpuser
echo Migration completed

fi

fi
